#!/bin/bash -e
#
#  Copyright (C) 2017 ScyllaDB

is_systemd() {
    grep -q '^systemd$' /proc/1/comm
}


interactive_ask_service() {
    echo $1
    echo $2
    while true; do
        if [ "$3" == "yes" ]; then
        prompt="[YES/no]"
        elif [ "$3" == "no" ]; then
        prompt="[yes/NO]"
        else
        prompt="[yes/no]"
        fi
        result=""
        while [ x == x"$result" ]; do
            read -p $prompt ans
            if [ x == x"$ans" ]; then
                result="$3"
            else
                result="$ans"
            fi
        done
        case $(echo $result | tr '[:upper:]' '[:lower:]') in
            "y" | "yes")
                return 1
                ;;
            "n" | "no")
                return 0
                ;;
        esac
    done
}

ENABLE_SCYLLA=0
ENABLE_SERVICE=1

if [ $# -ne 0 ]; then
    INTERACTIVE=0
else
    INTERACTIVE=1
fi

if [ $INTERACTIVE -eq 1 ]; then
    if [ -f /usr/lib/scylla/scylla_setup ]; then
        interactive_ask_service "Do you want to configure and enable the ScyllaDB instance used for this installation?" "Answer yes to configure and automatically start ScyllaDB when the node boots; answer no to skip this step." "yes" &&:
        ENABLE_SCYLLA=$?
    fi
    interactive_ask_service "Do you want to enable ScyllaDB management services?" "Answer yes to automatically start Scylla Manager when the node boots; answer no to skip this step." "yes" &&:
    ENABLE_SERVICE=$?
fi

if [ $ENABLE_SCYLLA -eq 1 ]; then
    /usr/lib/scylla/scylla_dev_mode_setup --developer-mode 1
    if is_systemd; then
        systemctl enable scylla-server.service
    fi
fi

if [ $ENABLE_SERVICE -eq 1 ]; then
    if is_systemd; then
        systemctl enable scylla-manager.service
    fi
fi

systemctl daemon-reload

echo "Scylla Manager setup finished."
