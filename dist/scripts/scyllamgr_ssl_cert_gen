#!/usr/bin/env bash
#
# Copyright 2018 ScyllaDB
#

set -eu -o pipefail

KEY_FILE="/var/lib/scylla-manager/scylla_manager.key"
CRT_FILE="/var/lib/scylla-manager/scylla_manager.crt"
SUBJECT="/C=US/ST=Scylla/L=Scylla/O=Scylla/OU=Scylla/CN=scylla.com"

print_usage() {
    echo "scyllamgr_ssl_cert_gen --subject <certificate subject>"
    echo "     --subject                specify certificate info, default is '${SUBJECT}'"
    echo "  -s --silent                 suppress error messages, default is false"
}

if [[ "$(id -u)" != "0" ]]; then
    echo "Requires root permission."
    exit 1
fi

SILENT=0

while [[ $# > 0 ]]; do
    case "$1" in
        "-s"|"--silent")
            SILENT=1
            shift 1
            ;;
        "--subject")
            SUBJECT="$2"
            shift 2
            ;;
        "-h" | "--help")
            print_usage
            exit 0
            ;;
        *)
            break
    esac
done


if [[ -f ${KEY_FILE} || -f ${CRT_FILE} ]]; then
    if [[ ${SILENT} == 0 ]]; then
        echo "certificate exists, to recreate run 'rm $KEY_FILE $CRT_FILE' and try again"
    fi
    exit 0
fi

openssl genrsa -out ${KEY_FILE} 4096 &> /dev/null
openssl req -new -x509 -sha512 -subj "${SUBJECT}" -key ${KEY_FILE} -out ${CRT_FILE} -days 365
chown scylla-manager:scylla-manager ${KEY_FILE} ${CRT_FILE}
