#!/usr/bin/make -f

import_path := github.com/scylladb/mermaid
builddir    := /tmp/mermaid_deb

GO_VERSION := 1.12.9
GO_HASH    := ac2a6efcc1f5ec8bdc0db0a988bb1d301d64b6d61b7e8d9e42f662fbb75a2b9b
GO_URL     := https://storage.googleapis.com/golang/go$(GO_VERSION).linux-amd64.tar.gz
GO_BUNDLE  := /tmp/go$(GO_VERSION).linux-amd64.tar.gz

GOROOT     := /tmp/go
GOPATH     := $(builddir)/_build
GOGCFLAGS  := all=-trimpath=$(GOPATH)
GOLDFLAGS  := -w -extldflags '-static' -X $(import_path).version=$(shell dpkg-parsechangelog --show-field Version)

GO := $(GOROOT)/bin/go

%:
	dh $@ --with=systemd

override_dh_auto_clean:
	rm -Rf $(builddir)

override_dh_auto_build:
	curl -sSq $(GO_URL) -o $(GO_BUNDLE)
	[ "`sha256sum $(GO_BUNDLE) | cut -c1-64`" = "$(GO_HASH)" ]
	tar -zxf $(GO_BUNDLE) -C /tmp

	mkdir -p $(builddir)/_build/src/github.com/scylladb
	ln -s `pwd` $(builddir)/_build/src/$(import_path)

	CGO_ENABLED=0 $(GO) build -a -mod vendor \
	-gcflags "$(GOGCFLAGS)" -ldflags "$(GOLDFLAGS) -B 0x$(head -c20 < /dev/urandom | xxd -p -c20)" \
	-o release/linux_amd64/scylla-manager $(import_path)/cmd/scylla-manager

	CGO_ENABLED=0 $(GO) build -a -mod vendor \
	-gcflags "$(GOGCFLAGS)" -ldflags "$(GOLDFLAGS) -B 0x$(head -c20 < /dev/urandom | xxd -p -c20)" \
	-o release/linux_amd64/sctool $(import_path)/cmd/sctool

	CGO_ENABLED=0 $(GO) build -a -mod vendor \
	-gcflags "$(GOGCFLAGS)" -ldflags "$(GOLDFLAGS) -B 0x$(head -c20 < /dev/urandom | xxd -p -c20)" \
	-o release/linux_amd64/scylla-manager-agent $(import_path)/cmd/agent

	mkdir -p release/bash_completion
	release/linux_amd64/sctool _bashcompletion > release/bash_completion/sctool.bash

override_dh_auto_test:

override_dh_systemd_enable:
	dh_systemd_enable --no-enable

override_dh_systemd_start:
	dh_systemd_start --restart-after-upgrade

