#!/usr/bin/make -f

import_path := github.com/scylladb/mermaid/pkg

GO_VERSION := 1.13.7
GO_HASH    := b3dd4bd781a0271b33168e627f7f43886b4c5d1c794a4015abf34e99c6526ca3
GO_URL     := https://storage.googleapis.com/golang/go$(GO_VERSION).linux-amd64.tar.gz
GO_BUNDLE  := ./go$(GO_VERSION).linux-amd64.tar.gz

GOROOT     := ./go
GOGCFLAGS  := all=-trimpath=$(GOPATH)
GOLDFLAGS  := -w -extldflags '-static' -X $(import_path).version=$(shell dpkg-parsechangelog --show-field Version)

GO := $(GOROOT)/bin/go

%:
	dh $@ --with=systemd

override_dh_auto_build:
	curl -sSq $(GO_URL) -o $(GO_BUNDLE)
	[ "`sha256sum $(GO_BUNDLE) | cut -c1-64`" = "$(GO_HASH)" ]
	tar -zxf $(GO_BUNDLE)

	CGO_ENABLED=0 $(GO) build -a -mod vendor \
	-gcflags "$(GOGCFLAGS)" -ldflags "$(GOLDFLAGS) -B 0x$(head -c20 < /dev/urandom | xxd -p -c20)" \
	-o release/linux_amd64/scylla-manager $(import_path)/cmd/scylla-manager

	CGO_ENABLED=0 $(GO) build -a -mod vendor \
	-gcflags "$(GOGCFLAGS)" -ldflags "$(GOLDFLAGS) -B 0x$(head -c20 < /dev/urandom | xxd -p -c20)" \
	-o release/linux_amd64/sctool $(import_path)/cmd/sctool

	CGO_ENABLED=0 $(GO) build -a -mod vendor \
	-gcflags "$(GOGCFLAGS)" -ldflags "$(GOLDFLAGS) -B 0x$(head -c20 < /dev/urandom | xxd -p -c20)" \
	-o release/linux_amd64/scylla-manager-agent $(import_path)/cmd/agent

	mkdir -p release/bash_completion
	release/linux_amd64/sctool _bashcompletion > release/bash_completion/sctool.bash

override_dh_auto_test:

override_dh_systemd_enable:
	dh_systemd_enable --no-enable

override_dh_systemd_start:
	dh_systemd_start --restart-after-upgrade

